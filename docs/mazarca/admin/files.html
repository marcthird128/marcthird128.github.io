<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="A Minecraft server that supports Eaglercraft 1.8 and 1.12">
    <link rel="icon" type="image/x-icon" href="../source/icon.png" />
    <link rel="stylesheet" href="../source/css/main.css" />
    <link rel="stylesheet" href="../source/css/admin.css" />
    <title>Mazarca Admin | Files</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px 0;
        }

        #files {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 0 auto;
            width: 30%;
            min-width: 150px;
        }

        .nav-btn {
            margin-top: auto;
            padding: 0;
            width: 100%;
            height: fit-content;
            display: flex;
            justify-content: flex-start;
        }
    </style>
    <script src="../source/js/auth.js"></script>
</head>
<body>
    <main class="wrapper wrapper-full">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%;">
                <h1 class="text-center no-margin">Files</h1>
                <select id="host-select">
                    <option data-host="raspberrypi" selected>Raspberry Pi</option>
                    <option data-host="oldlaptop" disabled>Old Laptop</option>
                    <option data-host="oldpc" disabled>Old PC</option>
                </select>
            </div>
            <div class="text-center" id="files">Fetching data, please wait...</div>
        </div>
        <div class="nav-btn">
            <a href="console.html" title="Console">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="#ffffff" d="M16 18a1 1 0 1 0 0-2zm-8-2a1 1 0 1 0 0 2zm.707-8.707a1 1 0 1 0-1.414 1.414zM11 11l.707.707a1 1 0 0 0 0-1.414zm-3.707 2.293a1 1 0 1 0 1.414 1.414zM7 4h10V2H7zm13 3v10h2V7zm-3 13H7v2h10zM4 17V7H2v10zm3 3a3 3 0 0 1-3-3H2a5 5 0 0 0 5 5zm13-3a3 3 0 0 1-3 3v2a5 5 0 0 0 5-5zM17 4a3 3 0 0 1 3 3h2a5 5 0 0 0-5-5zM7 2a5 5 0 0 0-5 5h2a3 3 0 0 1 3-3zm9 14H8v2h8zM7.293 8.707l3 3l1.414-1.414l-3-3zm3 1.586l-3 3l1.414 1.414l3-3z"/>
                </svg>
            </a>
        </div>
    </main>
    <div class="loading-overlay" id="loading-overlay"></div>
    <script>
        const knownText = ["txt", "yml", "yaml", "json", "bat"];
        const filesContainer = document.getElementById("files");
        const hst = document.getElementById("host-select");
        const overlay = document.getElementById("loading-overlay");
        let currentPath = "";

        async function loadFiles() {
            overlay.classList.add("active");
            let host = hst.options[hst.selectedIndex].dataset.host;
            const url = `https://${host}.maza64.xyz/${currentPath}`;
            console.log(url);
            try {
                const res = await authenticatedFetch(url);
                if (!res) return;
                const fileName = currentPath.split("/").at(-1);
                const ext = fileName?.split(".").at(-1)?.toLowerCase();
                if (ext && knownText.includes(ext)) {
                    window.location.href = `viewer.html?host=${host}&file=/${encodeURIComponent(currentPath)}`;
                    filesContainer.innerHTML = "<p>Redirecting to file view page...</p>";
                    return;
                };
                const fileList = await res.json();
                filesContainer.innerHTML = "";
                if (fileList) {
                    fileList.forEach((item) => {
                        filesContainer.innerHTML += `
                            <div class='file-item' onclick="changePath('${item}')">${item}</div>
                        `;
                    });
                };
            } catch (err) {
                filesContainer.innerHTML = `<p>Error: ${err.message}</p>`;
                console.error(err);
            } finally {
                // Hide overlay
                overlay.classList.remove("active");
            };
        };

        function changePath(to) {
            currentPath = currentPath ? `${currentPath}/${to}` : to;
            loadFiles();
        };

        // Initialize
        hst.addEventListener("change", () => {
            currentPath = "";
            loadFiles();
        });

        loadFiles();
    </script>
</body>
</html>