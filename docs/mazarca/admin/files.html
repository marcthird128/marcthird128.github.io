<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="A Minecraft server that supports Eaglercraft 1.8 and 1.12">
    <link rel="icon" type="image/x-icon" href="../source/icon.png" />
    <link rel="stylesheet" href="../source/css/main.css" />
    <link rel="stylesheet" href="../source/css/admin.css" />
    <title>Mazarca Admin | Files</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px 0;
        }

        #files {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 0 auto;
            width: 50%;
            min-width: 150px;
            height: 60vh;
            overflow-x: hidden;
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: #252525 #00000000;
        }

        .nav-btn {
            margin-top: auto;
            padding: 0;
            width: 100%;
            height: fit-content;
            display: flex;
            justify-content: flex-start;
        }

        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            cursor: pointer;
        }

        .custom-file-upload:hover {
            text-decoration: underline;
        }
    </style>
    <script src="../source/js/auth.js"></script>
</head>
<body>
    <main class="wrapper wrapper-full">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%;">
                <h1 class="text-center no-margin">Files</h1>
                <select id="host-select">
                    <option data-host="raspberrypi" selected>Raspberry Pi</option>
                    <option data-host="newlaptop" disabled>New Laptop</option>
                    <option data-host="marcomen" disabled>Gaming PC</option>
                    <option data-host="oldpc" disabled>Old PC</option>
                </select>
            </div>
            <div class="text-center" id="files">Fetching data, please wait...</div>
        </div>
        <form class="nav-btn footer" onsubmit="jumpTo(event)" autocomplete="off">
            <a href="console.html" title="Console">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="#ffffff" d="M16 18a1 1 0 1 0 0-2zm-8-2a1 1 0 1 0 0 2zm.707-8.707a1 1 0 1 0-1.414 1.414zM11 11l.707.707a1 1 0 0 0 0-1.414zm-3.707 2.293a1 1 0 1 0 1.414 1.414zM7 4h10V2H7zm13 3v10h2V7zm-3 13H7v2h10zM4 17V7H2v10zm3 3a3 3 0 0 1-3-3H2a5 5 0 0 0 5 5zm13-3a3 3 0 0 1-3 3v2a5 5 0 0 0 5-5zM17 4a3 3 0 0 1 3 3h2a5 5 0 0 0-5-5zM7 2a5 5 0 0 0-5 5h2a3 3 0 0 1 3-3zm9 14H8v2h8zM7.293 8.707l3 3l1.414-1.414l-3-3zm3 1.586l-3 3l1.414 1.414l3-3z"/>
                </svg>
            </a>
            <div style="cursor: pointer" title="Previous folder" onclick="backward()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path fill="#ffffff" d="M16 6a1 1 0 0 0-1.6-.8l-8 6a1 1 0 0 0 0 1.6l8 6A1 1 0 0 0 16 18z"/>
                </svg>
            </div>
            <input type="text" id="path-input" placeholder="Enter path...">
            <button class="secondary" type="submit" id="go-btn">Go</button>
            <div>
                <label for="file-upload" class="custom-file-upload" id="file-upload-label">Upload</label>
                <input type="file" id="file-upload">
            </div>
        </form>
    </main>
    <div class="loading-overlay" id="loading-overlay"></div>
    <script>
        const knownText = ["txt", "yml", "yaml", "json", "bat", "sh", "properties"];
        const filesContainer = document.getElementById("files");
        const hst = document.getElementById("host-select");
        const path = document.getElementById("path-input");
        const go = document.getElementById("go-btn");
        const upload = document.getElementById("file-upload");
        const overlay = document.getElementById("loading-overlay");
        let currentPath = "";
        let host = hst.options[hst.selectedIndex].dataset.host;

        async function loadFiles() {
            overlay.classList.add("active");
            path.disabled = true;
            go.disabled = true;
            const url = `https://${host}.maza64.xyz/${currentPath}`;
            try {
                const res = await authenticatedFetch(url);
                if (!res) return;
                const fileName = currentPath?.split("/").at(-1);
                const ext = fileName.includes(".") ? fileName.split(".").at(-1)?.toLowerCase() : null;
                if (ext) {
                currentPath = currentPath.split("/").slice(0, -1).join("/");
                    if (knownText.includes(ext)) {
                        if (confirm("This is a text file. Open it in editor?")) {
                            window.location.href = `viewer.html?host=${host}&file=${encodeURIComponent(currentPath ? currentPath+"/"+fileName : fileName)}`;
                        };
                        return;
                    } else {
                        if (confirm("This file can't be viewed, download it instead?")) {
                            const fileUrl = `https://${host}.maza64.xyz/${currentPath ? currentPath + "/" + fileName : fileName}`;
                            try {
                                const res = await authenticatedFetch(fileUrl);
                                if (!res.ok) {
                                    throw new Error(`Failed to fetch: ${res.status}`);
                                };
                                const blob = await res.blob();
                                const blobUrl = URL.createObjectURL(blob);
                                const a = document.createElement("a");
                                a.href = blobUrl;
                                a.download = fileName;
                                a.style.display = "none";
                                document.body.appendChild(a);
                                await a.click();
                                document.body.removeChild(a);
                                setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
                            } catch (err) {
                                alert("Download failed: " + err.message);
                                console.error(err);
                            };
                        };
                        return;
                    };
                };
                const fileList = await res.json();
                path.value = currentPath;
                filesContainer.innerHTML = "";
                if (fileList) {
                    fileList.forEach((item) => {
                        filesContainer.innerHTML += `
                            <div class="file-item">
                                <div onclick="forward('${item}')">${item}</div>
                                <div class="delete-btn" onclick="deleteFile('${item}')">Delete</div>
                            </div>
                        `;
                    });
                };
            } catch (err) {
                filesContainer.innerHTML = `<p>Error: ${err.message}</p>`;
                console.error(err);
            } finally {
                overlay.classList.remove("active");
                path.disabled = false;
                go.disabled = false;
            };
            filesContainer.scrollTop = "0";
        };

        function forward(to) {
            currentPath = currentPath ? `${currentPath}/${to}` : to;
            loadFiles();
        };

        function backward() {
            currentPath = currentPath ? currentPath.split("/").slice(0, -1).join("/") : "";
            loadFiles();
        };

        function jumpTo(e) {
            e.preventDefault();
            currentPath = path.value;
            loadFiles();
        };

        upload.addEventListener("change", async (event) => {
            const selectedFile = event.target.files[0];
            if (selectedFile) {
                if (confirm(`Upload ${selectedFile.name} to ${currentPath?currentPath:"/"}?`)) {
                    const newFileName = prompt("New file name? Leave empty to keep the original one.");
                    let res = await authenticatedFetch(`https://${host}.maza64.xyz/${(currentPath?currentPath+"/":"")+(newFileName?newFileName:selectedFile.name)}`, {
                        method: "PUT",
                        body: selectedFile
                    });
                    if (res.ok) {
                        alert("File uploaded successfully!");
                    } else {
                        alert("Something went wrong while uploading that file...");
                    };
                };
            };
            loadFiles();
        });

        async function deleteFile(f) {
            if (confirm(`Are you sure? File ${currentPath?currentPath+"/"+f:f} will be permanently deleted!`)) {
                let res = await authenticatedFetch(`https://${host}.maza64.xyz/${currentPath?currentPath+"/"+f:f}`, {
                    method: "DELETE"
                });
                if (res.ok) {
                    alert(`File ${currentPath?currentPath+"/"+f:f} deleted successfully!`);
                } else {
                    alert("Something went wrong while deleting that file...");
                };
                loadFiles();
            };
        };

        // Initialize
        hst.addEventListener("change", () => {
            currentPath = "";
            loadFiles();
        });

        loadFiles();
    </script>
</body>
</html>