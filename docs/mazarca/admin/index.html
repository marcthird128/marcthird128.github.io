<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="A Minecraft server that supports Eaglercraft 1.8 and 1.12">
    <link rel="icon" type="image/x-icon" href="../source/icon.png" />
    <link rel="stylesheet" href="../source/css/main.css" />
    <link rel="stylesheet" href="../source/css/admin.css" />
    <title>Mazarca Admin</title>
    <style>
        html {
            height: 100%;
        }

        body {
            height: calc(100% - 10px);
        }
    </style>
</head>
<body>
    <main class="wrapper wrapper-full">
        <div class="console">
            <pre id="console"></pre>
        </div>
        <form class="under-console" onsubmit="sendCommand(event)">
            <label for="command-prompt" style="font-family: MC-Regular">></label>
            <input type="text" id="command-prompt">
            <button type="submit" class="primary" id="send-btn">Send</button>
            <select id="server-select">
                <option data-host="raspberrypi" data-window="2">Lobby</option>
                <option data-host="raspberrypi" data-window="3">Minigames</option>
                <option data-host="oldpc" data-window="0">SMP</option>
                <option data-host="oldlaptop" data-window="0">Anarchy</option>
                <option disabled data-host="" data-window="">Random Drops</option>
            </select>
        </form>
    </main>
    <script>
        const con = document.getElementById("console");
        const cmd = document.getElementById("command-prompt");
        const btn = document.getElementById("send-btn");
        const srv = document.getElementById("server-select");
        const password = btoa(prompt("Password?"));
        console.log(password);

        // Get console history
        async function loadHistory() {
            console.log(`Loading console history for ${srv.value}`);
            let host = srv.options[srv.selectedIndex].dataset.host;
            let window = srv.options[srv.selectedIndex].dataset.window;
            try {
                let res = await fetch(`https://${host}.maza64.xyz/console?window=${window}`, {
                    method: "GET",
                    headers: {
                        Authorization: `${password}`
                    }
                });
                const t = await res.text();
                const previousScrollHeight = con.scrollHeight;
                const previousScrollTop = con.scrollTop;
                const maxScroll = previousScrollHeight - con.clientHeight;
                con.innerText = t.trim();
                if (maxScroll - previousScrollTop < 50) {
                    con.scrollTop = con.scrollHeight;
                };
            } catch (err) {
                alert(err);
            };
        };

        // Send a new command
        async function sendCommand(e) {
            e.preventDefault();
            let host = srv.options[srv.selectedIndex].dataset.host;
            let window = srv.options[srv.selectedIndex].dataset.window;
            let command = cmd.value;
            if (command) {
                cmd.disabled = true;
                btn.disabled = true;
                srv.disabled = true;
                console.log(`Executing command '${command}' in server '${srv.value}' (${host}, ${window})`);
                cmd.value = "";
                try {
                    let res = await fetch(`https://${host}.maza64.xyz/console?window=${window}&command=${command}`, {
                        method: "GET",
                        headers: {
                            Authorization: `${password}`
                        }
                    });
                    const t = await res.text();
                    con.innerText = t.trim();
                    con.scrollTop = con.scrollHeight;
                } catch (err) {
                    alert(err);
                };
                cmd.disabled = false;
                btn.disabled = false;
                srv.disabled = false;
            };
        };

        cmd.disabled = true;
        btn.disabled = true;
        srv.disabled = true;
        loadHistory();
        con.scrollTop = con.scrollHeight;
        cmd.disabled = false;
        btn.disabled = false;
        srv.disabled = false;
        setInterval(loadHistory, 5000);

        // Reload history when selected server has been changed
        srv.addEventListener("change", () => {
            loadHistory();
        });
    </script>
</body>
</html>
