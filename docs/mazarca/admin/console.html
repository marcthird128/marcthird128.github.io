<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="A Minecraft server that supports Eaglercraft 1.8 and 1.12">
    <link rel="icon" type="image/x-icon" href="../source/icon.png" />
    <link rel="stylesheet" href="../source/css/main.css" />
    <link rel="stylesheet" href="../source/css/admin.css" />
    <title>Mazarca Admin | Console</title>
    <style>
        html, body {
            margin: 0px;
            padding: 0px;
            height: 100%;
        }
    </style>
    <script src="../source/js/auth.js"></script>
</head>
<body>
    <main class="wrapper wrapper-full" style="padding: 0px; width: calc(100% - 20px); height: calc(100% - 20px);">
        <div class="console">
            <pre id="console"></pre>
        </div>
        <form class="footer" onsubmit="sendCommand(event)">
            <div style="display: flex; align-items: center; gap: 5px;">
                <a href="files.html" class="nav-btn" title="Manage files">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                        <g fill="none">
                            <path d="M24 0v24H0V0zM12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036c-.01-.003-.019 0-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427c-.002-.01-.009-.017-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092c.012.004.023 0 .029-.008l.004-.014l-.034-.614c-.003-.012-.01-.02-.02-.022m-.715.002a.023.023 0 0 0-.027.006l-.006.014l-.034.614c0 .012.007.02.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/>
                            <path fill="white" d="M12.52 3a2 2 0 0 1 1.442.614l.12.137L15.48 5.5H20a2 2 0 0 1 1.995 1.85L22 7.5V15a2 2 0 0 1-1.85 1.995L20 17h-2v2a2 2 0 0 1-1.85 1.995L16 21H4a2 2 0 0 1-1.995-1.85L2 19V9a2 2 0 0 1 1.85-1.995L4 7h2V5a2 2 0 0 1 1.85-1.995L8 3zm-4 6H4v10h12v-7.5h-4.52a2 2 0 0 1-1.561-.75zm4-4H8v2h.52a2 2 0 0 1 1.561.75l1.4 1.75H16a2 2 0 0 1 2 2V15h2V7.5h-4.52a2 2 0 0 1-1.561-.75z"/>
                        </g>
                    </svg>
                </a>
            </div>
            <label for="command-prompt" style="font-family: MC-Regular">></label>
            <input type="text" id="command-prompt">
            <button type="submit" class="primary" id="send-btn">Send</button>
            <select id="server-select">
                <option data-host="raspberrypi" data-window="1">Auth</option>
                <option data-host="raspberrypi" data-window="2" selected>Lobby</option>
                <option data-host="raspberrypi" data-window="3">Minigames</option>
                <option data-host="oldpc" data-window="0">SMP</option>
                <option data-host="oldlaptop" data-window="0">Anarchy</option>
                <option data-host="" data-window="" disabled>Random Drops</option>
            </select>
        </form>
    </main>
    <script>
        const con = document.getElementById("console");
        const cmd = document.getElementById("command-prompt");
        const btn = document.getElementById("send-btn");
        const srv = document.getElementById("server-select");

        async function loadHistory() {
            let host = srv.options[srv.selectedIndex].dataset.host;
            let window = srv.options[srv.selectedIndex].dataset.window;
            const url = `https://${host}.maza64.xyz/console?window=${window}`;
            try {
                const res = await authenticatedFetch(url);
                if (!res) return;
                const t = await res.text();
                const previousScrollHeight = con.scrollHeight;
                const previousScrollTop = con.scrollTop;
                const maxScroll = previousScrollHeight - con.clientHeight;
                con.innerText = t.trim();
                if (maxScroll - previousScrollTop < 50) {
                    con.scrollTop = con.scrollHeight;
                };
            } catch (err) {
                console.error(err);
            };
        };

        async function sendCommand(e) {
            e.preventDefault();
            let host = srv.options[srv.selectedIndex].dataset.host;
            let window = srv.options[srv.selectedIndex].dataset.window;
            let command = cmd.value;
            if (!command) return;
            cmd.disabled = true;
            btn.disabled = true;
            srv.disabled = true;
            cmd.value = "";
            const url = `https://${host}.maza64.xyz/console?window=${window}&command=${encodeURIComponent(command)}`;
            try {
                const res = await authenticatedFetch(url);
                if (!res) return;
                const t = await res.text();
                con.innerText = t.trim();
                con.scrollTop = con.scrollHeight;
            } catch (err) {
                console.error(err);
            } finally {
                cmd.disabled = false;
                btn.disabled = false;
                srv.disabled = false;
                cmd.focus();
            };
        };

        // Initialize
        cmd.disabled = true;
        btn.disabled = true;
        srv.disabled = true;
        loadHistory().finally(() => {
            cmd.disabled = false;
            btn.disabled = false;
            srv.disabled = false;
            cmd.focus();
        });
        con.scrollTop = con.scrollHeight;
        setInterval(loadHistory, 5000);

        srv.addEventListener("change", loadHistory);
    </script>
</body>
</html>