<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="A Minecraft server that supports Eaglercraft 1.8 and 1.12">
    <link rel="icon" type="image/x-icon" href="../source/icon.png" />
    <link rel="stylesheet" href="../source/css/main.css" />
    <link rel="stylesheet" href="../source/css/admin.css" />
    <title>Mazarca Admin | Playerlist</title>
    <style>
        html {
            height: 100%;
        }

        body {
            height: calc(100% - 40px);
        }
    </style>
    <script src="../source/js/auth.js"></script>
</head>
<body>
    <main class="wrapper wrapper-full">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-bottom: 15px;">
            <div id="nav-btn" title="Go back to console">
                <a href="console.html">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path fill="#ffffff" d="M16 18a1 1 0 1 0 0-2zm-8-2a1 1 0 1 0 0 2zm.707-8.707a1 1 0 1 0-1.414 1.414zM11 11l.707.707a1 1 0 0 0 0-1.414zm-3.707 2.293a1 1 0 1 0 1.414 1.414zM7 4h10V2H7zm13 3v10h2V7zm-3 13H7v2h10zM4 17V7H2v10zm3 3a3 3 0 0 1-3-3H2a5 5 0 0 0 5 5zm13-3a3 3 0 0 1-3 3v2a5 5 0 0 0 5-5zM17 4a3 3 0 0 1 3 3h2a5 5 0 0 0-5-5zM7 2a5 5 0 0 0-5 5h2a3 3 0 0 1 3-3zm9 14H8v2h8zM7.293 8.707l3 3l1.414-1.414l-3-3zm3 1.586l-3 3l1.414 1.414l3-3z"/>
                    </svg>
                </a>
            </div>
            <div style="flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 20px;">
                <h1 class="text-center no-margin">Playerlist</h1>
                <select id="server-select">
                    <option data-host="raspberrypi" data-window="2">Lobby</option>
                    <option data-host="raspberrypi" data-window="3">Minigames</option>
                    <option data-host="oldpc" data-window="0">SMP</option>
                    <option data-host="oldlaptop" data-window="0">Anarchy</option>
                    <option disabled data-host="" data-window="">Random Drops</option>
                </select>
            </div>
        </div>
        <p class="text-center" id="total">Fetching data, please wait...</p>
        <div id="players" class="playerlist"></div>
    </main>
    <script>
        const playersTotal = document.getElementById("total");
        const playersContainer = document.getElementById("players");
        const srv = document.getElementById("server-select");

        async function loadPlayerList() {
            let host = srv.options[srv.selectedIndex].dataset.host;
            let window = srv.options[srv.selectedIndex].dataset.window;
            const url = `https://${host}.maza64.xyz/playerlist?window=${window}`;
            try {
                const res = await authenticatedFetch(url);
                if (!res) return;
                const playerList = await res.json();
                playersTotal.innerText = `${playerList.total} players online in ${srv.value}`;
                playersContainer.innerHTML = "";
                if (playerList.groups) {
                    const allPlayers = [].concat(...Object.values(playerList.groups));
                    allPlayers.forEach((player) => {
                        let row = document.createElement("div");
                        row.className = "playerlist-row";
                        row.innerHTML = `
                            <p class="playername">${player}</p>
                            <hr size="2px" color="gray" class="flex-grow-1">
                            <button class="primary kick" onclick="kickPlayer('${host}', '${window}', '${player}')">Kick</button>
                            <button class="primary ban" onclick="banPlayer('${host}', '${window}', '${player}')">Ban!</button>
                        `;
                        playersContainer.appendChild(row);
                    });
                };
            } catch (err) {
                alert(err);
            };
        };

        async function kickPlayer(host, window, player) {
            if (!confirm(`Kick ${player}?`)) return;
            const url = `https://${host}.maza64.xyz/console?window=${window}&command=kick ${player}`;
            await authenticatedFetch(url);
            alert(`${player} kicked!`);
            loadPlayerList();
        };

        async function banPlayer(host, window, player) {
            const reason = prompt(`Ban ${player}? You must specify the reason below.`);
            if (!reason) return;
            const url = `https://${host}.maza64.xyz/console?window=${window}&command=ban ${player} ${reason}`;
            await authenticatedFetch(url);
            alert(`${player} banned for ${reason}!`);
            loadPlayerList();
        };

        // Initialize
        srv.addEventListener("change", () => {
            playersTotal.innerText = "Fetching data, please wait...";
            loadPlayerList();
        });
        loadPlayerList();
        setInterval(loadPlayerList, 5000);
    </script>
</body>

</html>
